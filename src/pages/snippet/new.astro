---
import DashboardLayout from '@/layouts/DashboardLayout.astro';
---

<DashboardLayout title="New Snippet - AI Snippet Manager">
  <div id="loading-state" class="flex justify-center items-center min-h-[400px]">
    <div class="text-center">
      <div class="text-4xl mb-4">‚è≥</div>
      <p class="text-gray-600">Loading...</p>
    </div>
  </div>

  <div id="snippet-form-container" class="hidden">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Create New Snippet</h1>
      <p class="text-gray-600">Add a new code snippet to your collection</p>
    </div>

    <div class="card max-w-4xl">
      <div id="snippet-form-mount"></div>
    </div>
  </div>

  <script>
    import { supabase } from '@/lib/supabase';
    import { createSnippet } from '@/lib/supabase';
    import SnippetForm from '@/components/snippets/SnippetForm';
    import { createRoot } from 'react-dom/client';
    import { createElement } from 'react';

    async function init() {
      // Check auth
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login';
        return;
      }

      // Show form
      document.getElementById('loading-state')!.classList.add('hidden');
      document.getElementById('snippet-form-container')!.classList.remove('hidden');

      // Mount React component
      const container = document.getElementById('snippet-form-mount')!;
      const root = createRoot(container);

      const handleSubmit = async (data: any) => {
        try {
          await createSnippet({
            ...data,
            user_id: session.user.id,
          });

          // Redirect to dashboard
          window.location.href = '/dashboard';
        } catch (error: any) {
          throw new Error(error.message || 'Failed to create snippet');
        }
      };

      root.render(
        createElement(SnippetForm, {
          onSubmit: handleSubmit,
          submitLabel: 'Create Snippet',
        })
      );
    }

    init();
  </script>
</DashboardLayout>
